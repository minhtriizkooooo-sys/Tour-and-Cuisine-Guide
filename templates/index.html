<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vietnam Cuisine & Tour Guide - Minh Tr√≠</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
    
    <style>
        :root { --primary: #0284c7; --bg: #f8fafc; --white: #ffffff; }
        body { margin: 0; display: flex; height: 100vh; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); }
        
        #map-container { flex: 1; position: relative; border-right: 2px solid #e2e8f0; }
        #map { height: 100%; width: 100%; }
        
        .map-tools { position: absolute; top: 10px; left: 50px; z-index: 1000; display: flex; gap: 8px; }
        .tool-btn { background: var(--white); border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-weight: bold; box-shadow: 0 2px 6px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 5px; }

        .map-panel { position: absolute; top: 60px; left: 50px; z-index: 1000; background: var(--white); padding: 15px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); width: 320px; display: none; }
        .map-panel input { width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 6px; }

        #chat-container { width: 450px; display: flex; flex-direction: column; background: var(--white); }
        .chat-header { background: var(--primary); color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        .chat-box { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 15px; }
        
        .msg { max-width: 85%; padding: 12px 16px; border-radius: 15px; line-height: 1.6; font-size: 14px; position: relative; }
        .user { align-self: flex-end; background: var(--primary); color: white; border-bottom-right-radius: 2px; }
        .bot { align-self: flex-start; background: #f1f5f9; color: #1e293b; border-bottom-left-radius: 2px; border: 1px solid #e2e8f0; }

        .ai-img { width: 100%; border-radius: 8px; margin-top: 10px; cursor: zoom-in; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .ai-section { margin-bottom: 10px; border-bottom: 1px dashed #ddd; padding-bottom: 5px; }
        .ai-section b { color: var(--primary); display: block; margin-bottom: 3px; }
        
        #overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:9999; display:none; justify-content:center; align-items:center; flex-direction:column; }
        #overlay img { max-width: 90%; max-height: 80%; border-radius: 8px; }

        #suggestions { padding: 10px; display: flex; gap: 8px; flex-wrap: wrap; border-top: 1px solid #eee; background: #fff; }
        .sug-btn { background: #f0f9ff; border: 1px solid #bae6fd; color: #0369a1; padding: 5px 12px; border-radius: 15px; font-size: 12px; cursor: pointer; }
        footer { padding: 10px; text-align: center; background: #f1f5f9; font-size: 13px; }
    </style>
</head>
<body>

<div id="map-container">
    <div class="map-tools">
        <button class="tool-btn" onclick="togglePanel('search-panel')"><i class="fa fa-search"></i> T√¨m ki·∫øm</button>
        <button class="tool-btn" onclick="togglePanel('route-panel')"><i class="fa fa-directions"></i> Ch·ªâ ƒë∆∞·ªùng</button>
        <button class="tool-btn" onclick="resetMap()"><i class="fa fa-home"></i> Reset</button>
    </div>

    <div id="search-panel" class="map-panel">
        <input type="text" id="search-input" placeholder="Nh·∫≠p t√™n ƒë·ªãa danh...">
        <button class="tool-btn" style="width:100%; justify-content: center;" onclick="searchLocation()">T√¨m ƒë·ªãa ƒëi·ªÉm</button>
    </div>

    <div id="route-panel" class="map-panel">
        <input type="text" id="start-node" placeholder="ƒêi·ªÉm ƒëi...">
        <input type="text" id="end-node" placeholder="ƒêi·ªÉm ƒë·∫øn...">
        <button class="tool-btn" style="width:100%; justify-content: center;" onclick="drawRoute()">D·∫´n ƒë∆∞·ªùng</button>
    </div>

    <div id="map"></div>
</div>

<div id="chat-container">
    <div class="chat-header">
        <span><b>üáªüá≥ Tour & Cuisine Guide</b></span>
        <div style="display:flex; gap:15px">
            <i class="fa fa-history" title="L·ªãch s·ª≠" onclick="loadHistory()" style="cursor:pointer"></i>
            <i class="fa fa-trash" title="X√≥a chat" onclick="clearHistory()" style="cursor:pointer"></i>
            <a href="/export_pdf" title="Xu·∫•t PDF" style="color:white"><i class="fa fa-file-pdf"></i></a>
        </div>
    </div>
    
    <div id="chat-box" class="chat-box">
        <div class="msg bot">Ch√†o b·∫°n! H√£y click v√†o b·∫£n ƒë·ªì ho·∫∑c nh·∫≠p ƒë·ªãa danh ƒë·ªÉ b·∫Øt ƒë·∫ßu nh√©!</div>
    </div>

    <div id="suggestions"></div>

    <div style="padding:15px; display:flex; gap:10px; border-top:1px solid #eee">
        <input type="text" id="user-input" placeholder="Nh·∫≠p tin nh·∫Øn..." style="flex:1; padding:10px; border-radius:20px; border:1px solid #ddd; outline:none">
        <button onclick="sendMessage()" style="background:var(--primary); color:white; border:none; width:40px; height:40px; border-radius:50%; cursor:pointer">
            <i class="fa fa-paper-plane"></i>
        </button>
    </div>

    <footer>Developer: <span style="color:var(--primary); font-weight:bold">L·∫°i Nguy·ªÖn Minh Tr√≠</span></footer>
</div>

<div id="overlay" onclick="this.style.display='none'">
    <img id="overlay-img" src="">
    <p id="overlay-caption" style="color:white; margin-top:10px"></p>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

<script>
    var map = L.map('map').setView([16.047, 108.206], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    var marker, routeControl;

    // 1. Click Map
    map.on('click', async function(e) {
        if(marker) map.removeLayer(marker);
        marker = L.marker(e.latlng).addTo(map);
        
        const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${e.latlng.lat}&lon=${e.latlng.lng}`);
        const data = await res.json();
        const placeName = data.address.city || data.address.province || data.address.state || "v·ªã tr√≠ n√†y";
        sendMessage(`K·ªÉ cho t√¥i v·ªÅ du l·ªãch v√† ·∫©m th·ª±c t·∫°i ${placeName}`);
    });

    // 2. G·ª≠i tin nh·∫Øn (ƒê√£ s·ª≠a .trim())
    async function sendMessage(text = null) {
        const input = document.getElementById('user-input');
        const msg = text || input.value.trim();
        if(!msg) return;
        input.value = "";

        appendMessage('user', msg);

        try {
            const response = await fetch('/chat', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({msg: msg})
            });
            const data = await response.json();
            renderBotResponse(data);
        } catch (e) {
            appendMessage('bot', 'L·ªói k·∫øt n·ªëi AI r·ªìi bro ∆°i!');
        }
    }

    // 3. G·ªôp h√†m RenderBotResponse (Fix tri·ªát ƒë·ªÉ l·ªói Undefined)
    function renderBotResponse(data) {
        const history = data.history || "ƒêang c·∫≠p nh·∫≠t l·ªãch s·ª≠...";
        const culture = data.culture || "ƒêang c·∫≠p nh·∫≠t vƒÉn h√≥a...";
        const cuisine = data.cuisine || "ƒêang c·∫≠p nh·∫≠t ·∫©m th·ª±c...";
        const travel = data.travel_tips || "ƒêang c·∫≠p nh·∫≠t t∆∞ v·∫•n...";
        
        const html = `
            <div class="ai-section"><b>üìú L·ªãch s·ª≠:</b> ${history}</div>
            <div class="ai-section"><b>üë• VƒÉn h√≥a:</b> ${culture}</div>
            <div class="ai-section"><b>üçú ·∫®m th·ª±c:</b> ${cuisine}</div>
            <div class="ai-section"><b>‚úàÔ∏è T∆∞ v·∫•n:</b> ${travel}</div>
            ${data.image_query ? `<img class="ai-img" src="https://source.unsplash.com/400x300/?${data.image_query}" onclick="showFullImg(this.src, '${data.image_query}')">` : ''}
            ${data.youtube_keyword ? `<div style="margin-top:10px">
                <iframe width="100%" height="200" src="https://www.youtube.com/embed?listType=search&list=${data.youtube_keyword} du l·ªãch" frameborder="0" allowfullscreen></iframe>
            </div>` : ''}
        `;
        appendMessage('bot', html);
        
        // C·∫≠p nh·∫≠t g·ª£i √Ω
        const sugBox = document.getElementById('suggestions');
        if (data.suggestions) {
            sugBox.innerHTML = data.suggestions.map(s => `<button class="sug-btn" onclick="sendMessage('${s}')">${s}</button>`).join('');
        }
    }

    // 4. Map & Chat Utils
    function togglePanel(id) {
        const p = document.getElementById(id);
        p.style.display = (p.style.display === 'block') ? 'none' : 'block';
    }

    async function searchLocation() {
        const query = document.getElementById('search-input').value;
        const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${query}`);
        const data = await res.json();
        if(data.length > 0) {
            const loc = data[0];
            map.setView([loc.lat, loc.lon], 12);
            if(marker) map.removeLayer(marker);
            marker = L.marker([loc.lat, loc.lon]).addTo(map);
            sendMessage(`Th√¥ng tin du l·ªãch v·ªÅ ${query}`);
        }
    }

    function resetMap() {
        map.setView([16.047, 108.206], 6);
        if(marker) map.removeLayer(marker);
    }

    function appendMessage(role, content) {
        const chatBox = document.getElementById('chat-box');
        const div = document.createElement('div');
        div.className = `msg ${role}`;
        div.innerHTML = content;
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    function showFullImg(src, caption) {
        document.getElementById('overlay-img').src = src;
        document.getElementById('overlay-caption').innerText = "ƒê·ªãa danh: " + caption;
        document.getElementById('overlay').style.display = 'flex';
    }

    async function clearHistory() {
        if(confirm("X√≥a l·ªãch s·ª≠ chat?")) {
            await fetch('/clear_history', {method: 'POST'});
            document.getElementById('chat-box').innerHTML = "";
            document.getElementById('suggestions').innerHTML = "";
            appendMessage('bot', 'L·ªãch s·ª≠ ƒë√£ x√≥a s·∫°ch!');
        }
    }

    async function loadHistory() {
        const res = await fetch('/history');
        const data = await res.json();
        document.getElementById('chat-box').innerHTML = "";
        data.forEach(m => {
            if(m.role === 'user') appendMessage('user', m.content);
            else renderBotResponse(m.content);
        });
    }
</script>
</body>
</html>

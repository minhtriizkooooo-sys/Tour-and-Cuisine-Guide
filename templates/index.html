<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Travel Pro 2025</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { margin: 0; display: flex; height: 100vh; font-family: sans-serif; overflow: hidden; }
        #map { flex: 1; position: relative; }
        
        /* Panel ƒëi·ªÅu khi·ªÉn tr√™n Map */
        .map-panel {
            position: absolute; top: 10px; left: 50px; z-index: 1000;
            background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); width: 280px;
        }
        .map-panel input { width: 100%; padding: 8px; margin-bottom: 5px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .map-panel button { width: 100%; padding: 10px; cursor: pointer; border: none; border-radius: 4px; font-weight: bold; margin-bottom: 5px; }

        /* Sidebar Chat */
        #sidebar { width: 400px; display: flex; flex-direction: column; border-left: 1px solid #ddd; background: white; }
        #chat-box { flex: 1; overflow-y: auto; padding: 15px; background: #f9f9f9; }
        .footer { padding: 15px; border-top: 1px solid #eee; background: white; }
        .msg { margin-bottom: 10px; padding: 10px; border-radius: 8px; font-size: 14px; }
        .bot { background: #eef; border-left: 4px solid blue; }
        .user { background: #007bff; color: white; align-self: flex-end; margin-left: 20px; }
    </style>
</head>
<body>

<div id="map">
    <div class="map-panel">
        <label><b>üîç T√¨m ƒë·ªãa ƒëi·ªÉm:</b></label>
        <input type="text" id="search-input" placeholder="Nh·∫≠p t√™n ƒë·ªãa danh..." onkeypress="if(event.key==='Enter') searchPlace()">
        <hr>
        <label><b>üõ£Ô∏è Ch·ªâ ƒë∆∞·ªùng:</b></label>
        <input type="text" id="start" placeholder="ƒêi·ªÉm ƒëi...">
        <input type="text" id="end" placeholder="ƒêi·ªÉm ƒë·∫øn...">
        <button onclick="drawRoute()" style="background: #28a745; color: white;">B·∫Øt ƒë·∫ßu ch·ªâ ƒë∆∞·ªùng</button>
        <button onclick="clearMap()" style="background: #dc3545; color: white;">X√≥a Marker/ƒê∆∞·ªùng</button>
    </div>
</div>

<div id="sidebar">
    <div id="chat-box">
        <div class="msg bot">Ch√†o b·∫°n! Nh·∫≠p l·ªô tr√¨nh b√™n tr√°i ƒë·ªÉ xem ƒë∆∞·ªùng ƒëi, ho·∫∑c h·ªèi t√¥i ·ªü d∆∞·ªõi nh√©.</div>
    </div>
    <div class="footer">
        <div style="display: flex; gap: 5px;">
            <input type="text" id="user-msg" style="flex:1; padding:10px; border-radius:20px; border:1px solid #ddd;" placeholder="H·ªèi AI v·ªÅ du l·ªãch...">
            <button onclick="sendAI()" style="background:blue; color:white; border:none; width:40px; border-radius:50%; cursor:pointer;"><i class="fa fa-paper-plane"></i></button>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

<script>
    const map = L.map('map').setView([10.7769, 106.7009], 13);
    L.tileLayer('https://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}&hl=vi', {subdomains:['mt0','mt1','mt2','mt3']}).addTo(map);

    let markers = [];
    let routing = null;

    // 1. T√¨m ki·∫øm v√† th·∫£ Marker
    async function searchPlace() {
        const q = document.getElementById('search-input').value;
        const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}`);
        const data = await res.json();
        if(data.length > 0) {
            const pos = [data[0].lat, data[0].lon];
            map.setView(pos, 15);
            const m = L.marker(pos).addTo(map).bindPopup(q).openPopup();
            markers.push(m);
        }
    }

    // 2. Click Map th·∫£ Marker
    map.on('click', async (e) => {
        const m = L.marker(e.latlng).addTo(map);
        markers.push(m);
        const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${e.latlng.lat}&lon=${e.latlng.lng}`);
        const data = await res.json();
        m.bindPopup(data.display_name).openPopup();
    });

    // 3. Ch·ªâ ƒë∆∞·ªùng (CH·ªà V·∫º ƒê∆Ø·ªúNG, KH√îNG G·ªåI AI)
    async function drawRoute() {
        const s = document.getElementById('start').value;
        const e = document.getElementById('end').value;
        if(!s || !e) return alert("Nh·∫≠p ƒë·ªß 2 ƒëi·ªÉm!");

        const sRes = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${s}`);
        const sData = await sRes.json();
        const eRes = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${e}`);
        const eData = await eRes.json();

        if(routing) map.removeControl(routing);
        
        routing = L.Routing.control({
            waypoints: [
                L.latLng(sData[0].lat, sData[0].lon),
                L.latLng(eData[0].lat, eData[0].lon)
            ],
            lineOptions: { styles: [{ color: 'blue', weight: 5 }] }
        }).addTo(map);
    }

    // 4. Chat AI (Ch·ªâ ch·∫°y khi ng∆∞·ªùi d√πng b·∫•m g·ª≠i tin nh·∫Øn)
    async function sendAI() {
        const input = document.getElementById('user-msg');
        const msg = input.value;
        if(!msg) return;
        input.value = "";
        
        const box = document.getElementById('chat-box');
        box.innerHTML += `<div class="msg user">${msg}</div>`;

        const res = await fetch('/chat', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({msg: msg})
        });
        const data = await res.json();
        box.innerHTML += `<div class="msg bot">${data.text}</div>`;
        box.scrollTop = box.scrollHeight;
    }

    function clearMap() {
        markers.forEach(m => map.removeLayer(m));
        if(routing) map.removeControl(routing);
        markers = [];
    }
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VIETNAM TRAVEL AI GUIDE - GEMMA 2 SPEED</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { --primary: #0066cc; --primary-dark: #004a7c; --bg: #f4f7f9; --accent: #f39c12; --sky-blue: #87CEEB; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', Arial; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; background: var(--bg); }
        header { background: linear-gradient(135deg, var(--primary-dark), var(--primary)); color: white; padding: 0 15px; height: 75px; display: flex; justify-content: space-between; align-items: center; z-index: 2000; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .logo { display: flex; align-items: center; gap: 12px; font-weight: bold; font-size: 22px; }
        .logo img { height: 65px; width: auto; }
        main { flex: 1; display: flex; position: relative; overflow: hidden; }
        #map-side { flex: 1; position: relative; z-index: 1; }
        #map { height: 100%; width: 100%; }
        .map-tools { position: absolute; top: 15px; left: 15px; z-index: 1001; width: 280px; display: flex; flex-direction: column; gap: 10px; }
        .tool-box { background: white; padding: 12px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .tool-box b { color: var(--primary); cursor: pointer; display: flex; justify-content: space-between; font-size: 14px; }
        .tool-box input { width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; }
        .btn-map { border: none; padding: 10px; border-radius: 8px; cursor: pointer; width: 100%; font-weight: bold; color: white; }
        
        #chat-side { width: 420px; background: white; display: flex; flex-direction: column; border-left: 1px solid #ddd; z-index: 1002; }
        .tab-bar { display: flex; background: #f8f9fa; border-bottom: 1px solid #eee; }
        .tab { flex: 1; padding: 15px 5px; text-align: center; cursor: pointer; font-size: 11px; font-weight: bold; color: #666; }
        .tab.active { color: var(--primary); border-bottom: 4px solid var(--primary); background: white; }
        
        .chat-box { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 15px; }
        .msg { padding: 12px 16px; border-radius: 18px; max-width: 88%; font-size: 15px; line-height: 1.5; }
        .user { background: var(--primary); color: white; align-self: flex-end; border-bottom-right-radius: 2px; }
        .bot { background: #f0f2f5; color: #333; align-self: flex-start; border-bottom-left-radius: 2px; }
        
        /* Gallery & Video */
        .image-gallery { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
        .image-item { flex: 1 1 140px; text-align: center; background: #e0e6eb; padding: 5px; border-radius: 8px; }
        .image-item img { width: 100%; height: 100px; object-fit: cover; border-radius: 5px; cursor: pointer; }
        .caption { font-size: 11px; color: #555; }
        .video-frame { margin-top: 10px; width: 100%; height: 200px; border-radius: 10px; overflow: hidden; }

        .input-area { padding: 15px; border-top: 1px solid #eee; display: flex; gap: 10px; }
        #user-input { flex: 1; padding: 12px 20px; border: 1px solid #ddd; border-radius: 30px; outline: none; }
        .send-btn { background: var(--primary); color: white; border: none; width: 45px; height: 45px; border-radius: 50%; cursor: pointer; }
        
        footer { background: var(--sky-blue); padding: 10px 20px; display: flex; justify-content: space-between; color: white; font-weight: bold; }
        .hidden { display: none !important; }
        .suggest-item { background: #eef7ff; color: var(--primary); padding: 8px; border-radius: 10px; margin-top: 5px; cursor: pointer; font-size: 13px; text-align: center; border: 1px solid #d0e7ff; }

        @media (max-width: 768px) {
            main { flex-direction: column; }
            #map-side { height: 40%; }
            #chat-side { width: 100%; height: 60%; }
            #chat-side { border-left: none; }
        }
    </style>
</head>
<body>
<header>
    <div class="logo">
        <img src="https://cdn-icons-png.flaticon.com/512/826/826070.png" alt="Logo">
        <span>TRAVEL AI GEMMA 2</span>
    </div>
    <i class="fa fa-sync-alt" onclick="location.reload()" style="cursor:pointer; font-size: 20px;"></i>
</header>
<main>
    <div id="map-side">
        <div class="map-tools">
            <div class="tool-box">
                <b onclick="toggleMinimize('s-content')">T√åM ƒê·ªäA DANH <i class="fa fa-chevron-down"></i></b>
                <div id="s-content">
                    <input type="text" id="s-input" placeholder="Nh·∫≠p t·ªânh th√†nh...">
                    <button class="btn-map" style="background: var(--primary);" onclick="findLoc()">C·∫Øm m·ªëc</button>
                </div>
            </div>
        </div>
        <div id="map"></div>
    </div>
    <div id="chat-side">
        <div class="tab-bar">
            <div class="tab active" onclick="setTab('chat')">H·ªòI THO·∫†I</div>
            <div class="tab" onclick="loadHistory()">L·ªäCH S·ª¨</div>
            <div class="tab" onclick="clearHistory()" style="color:#e74c3c;">X√ìA</div>
        </div>
        <div id="chat-box" class="chat-box">
            <div class="msg bot">Ch√†o b·∫°n! T√¥i l√† Gemma 2. B·∫°n mu·ªën kh√°m ph√° n∆°i n√†o t·∫°i Vi·ªát Nam h√¥m nay? üáªüá≥</div>
        </div>
        <div id="pdf-area" class="hidden" style="padding:10px; text-align:center;">
            <button onclick="window.location.href='/export_pdf'" style="background:#27ae60; color:white; border:none; padding:8px 15px; border-radius:20px; cursor:pointer; font-weight:bold;">
                <i class="fa fa-file-pdf"></i> T·∫£i PDF
            </button>
        </div>
        <div class="input-area">
            <input type="text" id="user-input" placeholder="H·ªèi AI du l·ªãch..." onkeypress="if(event.key==='Enter') sendMessage()">
            <button class="send-btn" onclick="sendMessage()"><i class="fa fa-paper-plane"></i></button>
        </div>
    </div>
</main>
<footer>
    <div>Dev: L·∫°i Nguy·ªÖn Minh Tr√≠</div>
    <div>84.908.08.35.66</div>
</footer>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const map = L.map('map', { zoomControl: false, attributionControl: false }).setView([16.047, 108.206], 6);
    L.tileLayer('https://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}&hl=vi', { subdomains:['mt0','mt1','mt2','mt3'] }).addTo(map);
    let markers = [];

    function toggleMinimize(id) { document.getElementById(id).classList.toggle('hidden'); }

    async function findLoc() {
        const q = document.getElementById('s-input').value;
        if(!q) return;
        const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}`);
        const data = await res.json();
        if(data[0]) {
            const pos = [data[0].lat, data[0].lon];
            map.setView(pos, 13);
            L.marker(pos).addTo(map).bindPopup(`<b>${q}</b><br><button onclick="askAI('${q}')">H·ªèi AI</button>`).openPopup();
        }
    }

    function askAI(loc) {
        document.getElementById('user-input').value = `Review du l·ªãch t·∫°i ${loc}`;
        sendMessage();
    }

    function getYouTubeId(url) {
        const match = url.match(/(?:v=|\/)([0-9A-Za-z_-]{11})/);
        return match ? match[1] : null;
    }

    function createMessageElement(role, content) {
        const div = document.createElement('div');
        div.className = `msg ${role}`;
        
        if (role === 'user') {
            div.textContent = content;
        } else {
            let data;
            try {
                // X·ª≠ l√Ω JSON t·ª´ Gemma (lo·∫°i b·ªè markdown block n·∫øu c√≥)
                const clean = typeof content === 'string' ? content.replace(/```json|```/g, '').trim() : content;
                data = typeof clean === 'string' ? JSON.parse(clean) : clean;
            } catch (e) {
                data = { text: content };
            }

            const text = document.createElement('div');
            text.innerHTML = (data.text || "").replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
            div.appendChild(text);

            if (data.images) {
                const gal = document.createElement('div');
                gal.className = 'image-gallery';
                data.images.forEach(img => {
                    const item = document.createElement('div');
                    item.className = 'image-item';
                    item.innerHTML = `<img src="${img.url}" onclick="window.open('${img.url}')"><div class="caption">${img.caption || ''}</div>`;
                    gal.appendChild(item);
                });
                div.appendChild(gal);
            }

            if (data.youtube_links) {
                data.youtube_links.forEach(link => {
                    const id = getYouTubeId(link);
                    if(id) div.innerHTML += `<div class="video-frame"><iframe src="https://www.youtube.com/embed/${id}" frameborder="0" allowfullscreen style="width:100%; height:100%"></iframe></div>`;
                });
            }

            if (data.suggestions) {
                data.suggestions.forEach(s => {
                    const btn = document.createElement('div');
                    btn.className = 'suggest-item';
                    btn.textContent = s;
                    btn.onclick = () => { document.getElementById('user-input').value = s; sendMessage(); };
                    div.appendChild(btn);
                });
            }
        }
        return div;
    }

    async function sendMessage() {
        const input = document.getElementById('user-input');
        const msg = input.value.trim();
        if(!msg) return;
        
        const chatBox = document.getElementById('chat-box');
        chatBox.appendChild(createMessageElement('user', msg));
        input.value = '';
        
        try {
            const res = await fetch('/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ msg: msg })
            });
            const data = await res.json();
            chatBox.appendChild(createMessageElement('bot', data));
            chatBox.scrollTop = chatBox.scrollHeight;
        } catch (e) {
            console.error(e);
        }
    }

    function setTab(t) {
        document.getElementById('pdf-area').classList.toggle('hidden', t === 'chat');
        if(t === 'chat') {
            document.getElementById('chat-box').innerHTML = '<div class="msg bot">Ch√†o b·∫°n! H√£y ti·∫øp t·ª•c cu·ªôc tr√≤ chuy·ªán.</div>';
            loadHistory(true);
        }
    }

    async function loadHistory(isChat = false) {
        const res = await fetch('/history');
        const data = await res.json();
        const chatBox = document.getElementById('chat-box');
        if(!isChat) chatBox.innerHTML = '';
        data.forEach(item => chatBox.appendChild(createMessageElement(item.role, item.content)));
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    async function clearHistory() {
        if(confirm("X√≥a h·∫øt?")) {
            await fetch('/clear_history', { method: 'POST' });
            location.reload();
        }
    }
</script>
</body>
</html>

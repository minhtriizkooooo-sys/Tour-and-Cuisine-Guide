<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vietnam Travel AI - B·∫£n ƒë·ªì & H∆∞·ªõng d·∫´n</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        :root { --blue: #0077b6; --light-blue: #00b4d8; --green: #2d6a4f; --gray: #f4f7f6; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Arial, sans-serif; }
        
        body { display: flex; flex-direction: column; height: 100vh; background: var(--gray); }
        
        /* Header */
        header { 
            background: linear-gradient(90deg, var(--blue), var(--light-blue)); 
            color: white; padding: 10px 15px; 
            display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 1001;
        }
        .logo-area { display: flex; align-items: center; gap: 10px; }
        header img { height: 45px; background: white; border-radius: 5px; padding: 2px; }

        /* Layout Main */
        #main-layout { display: flex; flex: 1; overflow: hidden; flex-direction: row; }

        /* Map Side */
        #map-side { width: 60%; position: relative; border-right: 2px solid #ddd; }
        #map { height: 100%; width: 100%; }

        .map-overlay {
            position: absolute; top: 10px; left: 10px; z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            padding: 12px; border-radius: 10px; width: 280px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .map-overlay input, .map-overlay select {
            width: 100%; padding: 8px; margin-bottom: 5px;
            border: 1px solid #ccc; border-radius: 5px; font-size: 14px;
        }
        .map-overlay button {
            width: 100%; padding: 8px; border: none; border-radius: 5px;
            cursor: pointer; font-weight: bold; margin-bottom: 5px; color: white;
        }

        /* Chat Side */
        #chat-side { width: 40%; display: flex; flex-direction: column; background: white; }
        .tabs { display: flex; background: #eee; }
        .tab-btn { flex: 1; padding: 12px; border: none; cursor: pointer; font-weight: bold; color: #555; }
        .tab-btn.active { background: white; color: var(--blue); border-top: 3px solid var(--blue); }

        #chat-box { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 12px; }
        .msg { padding: 12px; border-radius: 10px; max-width: 90%; line-height: 1.5; font-size: 15px; }
        .user-msg { align-self: flex-end; background: var(--light-blue); color: white; }
        .bot-msg { align-self: flex-start; background: #f1f1f1; color: #333; border-left: 5px solid var(--blue); }
        
        #loading-row { display: none; text-align: center; padding: 10px; font-size: 13px; color: #666; }

        /* Input Area */
        .input-area { padding: 10px; display: flex; gap: 8px; border-top: 1px solid #ddd; }
        .input-area input { flex: 1; padding: 10px 15px; border-radius: 20px; border: 1px solid #ccc; outline: none; }
        .input-area button { background: var(--blue); color: white; border: none; padding: 0 20px; border-radius: 20px; cursor: pointer; }

        footer { background: var(--green); color: white; text-align: center; padding: 5px; font-size: 11px; }

        /* RESPONSIVE CHO MOBILE */
        @media (max-width: 768px) {
            #main-layout { flex-direction: column; }
            #map-side { width: 100%; height: 40vh; }
            #chat-side { width: 100%; height: 60vh; }
            .map-overlay { width: 200px; padding: 8px; font-size: 12px; }
            header h2 { font-size: 14px !important; }
        }
    </style>
</head>
<body>

<header>
    <div class="logo-area">
        <img src="/static/images/Logo_Marie_Curie.png" onerror="this.src='https://via.placeholder.com/50'" alt="Logo">
        <div>
            <h2 style="font-size: 16px;">VIETNAM TRAVEL AI</h2>
            <p style="font-size: 10px; opacity: 0.9;">H∆∞·ªõng d·∫´n vi√™n th√¥ng minh 24/7</p>
        </div>
    </div>
</header>

<div id="main-layout">
    <div id="map-side">
        <div class="map-overlay">
            <input type="text" id="map-search-input" placeholder="üîç T√¨m ƒë·ªãa danh...">
            <button style="background: var(--blue);" onclick="searchPlace()">T√¨m & H·ªèi AI</button>
            <input type="text" id="start-node" placeholder="üö© ƒêi·ªÉm ƒëi">
            <input type="text" id="end-node" placeholder="üèÅ ƒêi·ªÉm ƒë·∫øn">
            <button style="background: var(--green);" onclick="drawRoute()">Ch·ªâ ƒë∆∞·ªùng</button>
            <button style="background: #6c757d;" onclick="clearMarkers()">X√≥a Map</button>
        </div>
        <div id="map"></div>
    </div>

    <div id="chat-side">
        <div class="tabs">
            <button class="tab-btn active" id="tab-c" onclick="toggleTab('chat')">H·ªôi tho·∫°i</button>
            <button class="tab-btn" id="tab-h" onclick="toggleTab('hist')">L·ªãch s·ª≠</button>
            <button class="tab-btn" onclick="exportToPDF()" style="color: red;">Xu·∫•t PDF</button>
        </div>
        
        <div id="chat-box">
            <div class="msg bot-msg">üëã Ch√†o b·∫°n! T√¥i l√† tr·ª£ l√Ω du l·ªãch AI. H√£y nh·∫≠p ƒë·ªãa danh b·∫°n mu·ªën kh√°m ph√° ho·∫∑c ch·ªçn tr√™n b·∫£n ƒë·ªì nh√©!</div>
            <div id="loading-row">‚åõ ƒêang x·ª≠ l√Ω d·ªØ li·ªáu...</div>
        </div>

        <div id="history-box" style="display:none; padding: 15px; overflow-y: auto; flex:1;">
            <div id="hist-list"></div>
        </div>

        <div class="input-area">
            <input type="text" id="user-msg-input" placeholder="H·ªèi AI v·ªÅ du l·ªãch...">
            <button onclick="sendUserMsg()">G·ª≠i</button>
        </div>
    </div>
</div>

<footer>Hotline: +84-908-08-3566 - ¬© 2025 Vietnam Travel AI</footer>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

<script>
    // Kh·ªüi t·∫°o Map
    const map = L.map('map').setView([16.047, 108.206], 6);
    L.tileLayer('http://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}&hl=vi', {
        subdomains:['mt0','mt1','mt2','mt3']
    }).addTo(map);

    let markers = [];
    let routeControl = null;

    function clearMarkers() {
        markers.forEach(m => map.removeLayer(m));
        markers = [];
        if(routeControl) map.removeControl(routeControl);
    }

    async function searchPlace() {
        const q = document.getElementById('map-search-input').value;
        if(!q) return;
        const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}&limit=1`);
        const data = await res.json();
        if(data[0]) {
            const lat = data[0].lat, lon = data[0].lon;
            map.setView([lat, lon], 13);
            const m = L.marker([lat, lon]).addTo(map).bindPopup(q).openPopup();
            markers.push(m);
            sendUserMsg(`Gi·ªõi thi·ªáu v·ªÅ ${q}`);
        }
    }

    async function drawRoute() {
        const s = document.getElementById('start-node').value;
        const e = document.getElementById('end-node').value;
        if(!s || !e) return alert("Nh·∫≠p ƒëi·ªÉm ƒëi/ƒë·∫øn");
        
        const resS = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${s}&limit=1`).then(r => r.json());
        const resE = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${e}&limit=1`).then(r => r.json());

        if(resS[0] && resE[0]) {
            if(routeControl) map.removeControl(routeControl);
            routeControl = L.Routing.control({
                waypoints: [L.latLng(resS[0].lat, resS[0].lon), L.latLng(resE[0].lat, resE[0].lon)],
                language: 'vi',
                lineOptions: { styles: [{ color: '#0077b6', weight: 5 }] }
            }).addTo(map);
            sendUserMsg(`T∆∞ v·∫•n l·ªô tr√¨nh t·ª´ ${s} ƒëi ${e}`);
        }
    }

    async function sendUserMsg(manualMsg = null) {
        const input = document.getElementById('user-msg-input');
        const msg = manualMsg || input.value;
        if(!msg) return;

        input.value = "";
        const box = document.getElementById('chat-box');
        box.innerHTML += `<div class="msg user-msg">${msg}</div>`;
        document.getElementById('loading-row').style.display = 'block';
        box.scrollTop = box.scrollHeight;

        try {
            const response = await fetch('/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ msg: msg })
            });
            const data = await response.json();
            document.getElementById('loading-row').style.display = 'none';

            // Hi·ªÉn th·ªã n·ªôi dung t·ª´ AI (H·ªó tr·ª£ HTML)
            box.innerHTML += `<div class="msg bot-msg">${data.text}</div>`;
            
            // Th√™m v√†o l·ªãch s·ª≠
            document.getElementById('hist-list').innerHTML = `<p style="cursor:pointer; border-bottom:1px solid #eee; padding:5px;" onclick="sendUserMsg('${msg}')">üìç ${msg}</p>` + document.getElementById('hist-list').innerHTML;
        } catch (e) {
            document.getElementById('loading-row').style.display = 'none';
            box.innerHTML += `<div class="msg bot-msg">‚ö†Ô∏è L·ªói k·∫øt n·ªëi AI. Th·ª≠ l·∫°i sau!</div>`;
        }
        box.scrollTop = box.scrollHeight;
    }

    function toggleTab(type) {
        document.getElementById('chat-box').style.display = type === 'chat' ? 'flex' : 'none';
        document.getElementById('history-box').style.display = type === 'hist' ? 'block' : 'none';
        document.getElementById('tab-c').classList.toggle('active', type === 'chat');
        document.getElementById('tab-h').classList.toggle('active', type === 'hist');
    }

    function exportToPDF() {
        const element = document.getElementById('chat-box');
        html2pdf().from(element).save('Lich_su_du_lich.pdf');
    }
</script>
</body>
</html>

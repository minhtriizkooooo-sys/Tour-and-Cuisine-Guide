<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vietnam Travel Platform Pro</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root { --blue: #1a73e8; --gray: #f1f3f4; --red: #ff4757; }
        body { margin: 0; display: flex; flex-direction: column; height: 100vh; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        /* Header */
        header { background: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ddd; z-index: 1001; }
        .logo-area { display: flex; align-items: center; gap: 10px; }
        .tab-box { display: flex; gap: 10px; background: var(--gray); padding: 5px; border-radius: 20px; }
        .tab { padding: 8px 18px; cursor: pointer; border-radius: 15px; font-weight: bold; font-size: 13px; transition: 0.3s; }
        .tab.active { background: var(--blue); color: white; }

        #main { display: flex; flex: 1; overflow: hidden; position: relative; }
        
        /* Map Section */
        #map { flex: 1; position: relative; z-index: 1; }
        
        /* Navigation & Search Panel on Map */
        .map-overlay {
            position: absolute; top: 20px; left: 60px; z-index: 1000;
            background: white; padding: 15px; border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); width: 300px;
        }
        .map-overlay input { width: 100%; padding: 10px; margin-bottom: 8px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
        .map-overlay button { width: 100%; padding: 10px; background: var(--blue); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; margin-bottom: 5px; }
        .btn-clear-map { background: var(--red) !important; }

        /* Chat Sidebar */
        #chat-side { width: 420px; display: flex; flex-direction: column; border-left: 1px solid #ddd; background: #fff; z-index: 2; }
        #chat-box { flex: 1; overflow-y: auto; padding: 15px; background: #f8f9fa; scroll-behavior: smooth; }
        #history-box { flex: 1; overflow-y: auto; padding: 15px; display: none; }
        
        /* Message Bubbles */
        .msg { margin-bottom: 15px; padding: 12px 15px; border-radius: 15px; font-size: 14px; line-height: 1.5; max-width: 85%; }
        .bot { background: white; border-left: 5px solid var(--blue); align-self: flex-start; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .user { background: var(--blue); color: white; align-self: flex-end; margin-left: auto; border-bottom-right-radius: 2px; }

        .bot img { width: 100%; border-radius: 10px; margin: 10px 0; border: 1px solid #eee; }
        .video-box { position: relative; padding-bottom: 56.25%; height: 0; margin: 10px 0; overflow: hidden; border-radius: 10px; }
        .video-box iframe { position: absolute; top:0; left:0; width:100%; height:100%; }

        /* Footer Chat Area */
        .chat-footer { padding: 15px; border-top: 1px solid #eee; background: white; }
        .suggest-row { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px; }
        .sug-btn { background: #f0f4ff; color: var(--blue); border: 1px solid #d0dfff; padding: 6px 12px; border-radius: 15px; font-size: 12px; cursor: pointer; }
        .input-row { display: flex; gap: 10px; align-items: center; }
        .input-row input { flex: 1; padding: 12px 15px; border-radius: 25px; border: 1px solid #ddd; outline: none; font-size: 14px; }
        .send-btn { background: var(--blue); color: white; border: none; width: 45px; height: 45px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.3s; }
        .send-btn:hover { transform: scale(1.1); }
        
        .actions { display: flex; gap: 10px; margin-top: 12px; }
        .act-btn { flex: 1; padding: 10px; font-size: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 5px; }

        @media (max-width: 768px) { #main { flex-direction: column; } #chat-side { width: 100%; height: 50%; } .map-overlay { width: 80%; left: 10%; } }
    </style>
</head>
<body>

<header>
    <div class="logo-area">
        <img src="/static/images/Logo_Marie_Curie.png" height="40" onerror="this.src='https://via.placeholder.com/40'">
        <b style="color:var(--blue); font-size: 18px;">VIETNAM TRAVEL AI</b>
    </div>
    <div class="tab-box">
        <div class="tab active" id="t1" onclick="showTab('chat')"><i class="fa fa-comments"></i> H·ªôi tho·∫°i</div>
        <div class="tab" id="t2" onclick="showTab('history')"><i class="fa fa-history"></i> L·ªãch s·ª≠</div>
    </div>
</header>

<div id="main">
    <div id="map">
        <div class="map-overlay">
            <div style="font-weight: bold; margin-bottom: 10px; color: #333;"><i class="fa fa-route"></i> Ch·ªâ ƒë∆∞·ªùng & T√¨m ki·∫øm</div>
            <input type="text" id="start-node" placeholder="Nh·∫≠p ƒëi·ªÉm ƒëi...">
            <input type="text" id="end-node" placeholder="Nh·∫≠p ƒëi·ªÉm ƒë·∫øn ho·∫∑c t√¨m ƒë·ªãa danh...">
            <button onclick="calculateRoute()"><i class="fa fa-location-arrow"></i> B·∫Øt ƒë·∫ßu ch·ªâ ƒë∆∞·ªùng</button>
            <button class="btn-clear-map" onclick="clearAllMap()"><i class="fa fa-eraser"></i> X√≥a b·∫£n ƒë·ªì</button>
            <div id="route-info" style="font-size: 12px; color: #666; margin-top: 5px;"></div>
        </div>
    </div>

    <div id="chat-side">
        <div id="chat-box" style="display: flex; flex-direction: column;">
            <div class="msg bot">üìç Ch√†o m·ª´ng b·∫°n! B·∫°n c√≥ th·ªÉ nh·∫≠p l·ªô tr√¨nh b√™n tr√°i ho·∫∑c h·ªèi t√¥i b·∫•t c·ª© ƒëi·ªÅu g√¨ v·ªÅ du l·ªãch v√† m√≥n ƒÉn Vi·ªát Nam.</div>
        </div>

        <div id="history-box">
            <h4 style="margin-top: 0; color: var(--blue); border-bottom: 2px solid var(--blue); padding-bottom: 5px;">L·ªãch s·ª≠ chuy·∫øn ƒëi</h4>
            <div id="history-list"></div>
        </div>

        <div class="chat-footer">
            <div class="suggest-row" id="sug-box"></div>
            <div class="input-row">
                <input type="text" id="user-in" placeholder="Nh·∫≠p c√¢u h·ªèi t·∫°i ƒë√¢y...">
                <button class="send-btn" onclick="sendMsg()"><i class="fa fa-paper-plane"></i></button>
            </div>
            <div class="actions">
                <button class="act-btn" style="background:#eee; color: #555;" onclick="clearHistory()"><i class="fa fa-trash"></i> X√≥a l·ªãch s·ª≠</button>
                <button class="act-btn" style="background:var(--red); color:white" onclick="exportPDF()"><i class="fa fa-file-pdf"></i> Xu·∫•t PDF</button>
            </div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<script>
    // 1. Kh·ªüi t·∫°o b·∫£n ƒë·ªì
    const map = L.map('map').setView([10.7769, 106.7009], 13);
    L.tileLayer('https://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}&hl=vi', {
        subdomains:['mt0','mt1','mt2','mt3'],
        maxZoom: 20
    }).addTo(map);

    let routingControl = null;
    let markers = [];

    // 2. Chuy·ªÉn ƒë·ªïi Tab
    function showTab(type) {
        document.getElementById('chat-box').style.display = type === 'chat' ? 'flex' : 'none';
        document.getElementById('history-box').style.display = type === 'history' ? 'block' : 'none';
        document.getElementById('t1').classList.toggle('active', type === 'chat');
        document.getElementById('t2').classList.toggle('active', type === 'history');
    }

    // 3. H√†m t√¨m t·ªça ƒë·ªô (Geocoding)
    async function getPoint(name) {
        try {
            const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(name)}`);
            const data = await res.json();
            return data.length > 0 ? { lat: data[0].lat, lon: data[0].lon } : null;
        } catch (e) { return null; }
    }

    // 4. T√≠nh to√°n ƒë∆∞·ªùng ƒëi
    async function calculateRoute() {
        const startName = document.getElementById('start-node').value;
        const endName = document.getElementById('end-node').value;

        if (!startName || !endName) {
            alert("Vui l√≤ng nh·∫≠p ƒë·ªß ƒêi·ªÉm ƒëi v√† ƒêi·ªÉm ƒë·∫øn!");
            return;
        }

        const start = await getPoint(startName);
        const end = await getPoint(endName);

        if (!start || !end) {
            alert("Kh√¥ng t√¨m th·∫•y ƒë·ªãa danh. H√£y th·ª≠ t√™n c·ª• th·ªÉ h∆°n (Vd: Ch·ª£ B·∫øn Th√†nh, Qu·∫≠n 1)");
            return;
        }

        if (routingControl) map.removeControl(routingControl);

        routingControl = L.Routing.control({
            waypoints: [L.latLng(start.lat, start.lon), L.latLng(end.lat, end.lon)],
            lineOptions: { styles: [{ color: '#1a73e8', weight: 6 }] },
            router: L.Routing.osrmv1({ serviceUrl: `https://router.project-osrm.org/route/v1` }),
            language: 'vi',
            createMarker: function(i, wp) {
                return L.marker(wp.latLng).bindPopup(i === 0 ? "ƒêi·ªÉm ƒëi" : "ƒêi·ªÉm ƒë·∫øn");
            }
        }).on('routesfound', function(e) {
            const routes = e.routes[0];
            const dist = (routes.summary.totalDistance / 1000).toFixed(1);
            const time = Math.round(routes.summary.totalTime / 60);
            document.getElementById('route-info').innerHTML = `<b>Kho·∫£ng c√°ch:</b> ${dist} km | <b>Th·ªùi gian:</b> ${time} ph√∫t`;
        }).addTo(map);

        sendMsg(`T√¥i mu·ªën ƒëi t·ª´ ${startName} ƒë·∫øn ${endName}. H√£y t∆∞ v·∫•n l·ªãch tr√¨nh v√† m√≥n ƒÉn ngon d·ªçc ƒë∆∞·ªùng.`);
    }

    // 5. G·ª≠i tin nh·∫Øn cho AI
    async function sendMsg(manualMsg = null) {
        const input = document.getElementById('user-in');
        const text = manualMsg || input.value;
        if (!text) return;
        input.value = "";

        const box = document.getElementById('chat-box');
        box.innerHTML += `<div class="msg user">${text}</div>`;
        box.scrollTop = box.scrollHeight;

        try {
            const res = await fetch('/chat', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({msg: text})
            });
            const data = await res.json();
            
            let html = `<div class="msg bot">`;
            if (data.image_tag) html += `<img src="https://source.unsplash.com/800x600/?${data.image_tag}" alt="travel">`;
            html += `<div>${data.text}</div>`;
            if (data.video_id) html += `<div class="video-box"><iframe src="https://www.youtube.com/embed/${data.video_id}" frameborder="0" allowfullscreen></iframe></div>`;
            html += `</div>`;
            
            box.innerHTML += html;
            updateSug(data.suggestions);
            saveToHistory(text, data.text);
        } catch (e) {
            box.innerHTML += `<div class="msg bot">L·ªói k·∫øt n·ªëi AI. Vui l√≤ng th·ª≠ l·∫°i.</div>`;
        }
        box.scrollTop = box.scrollHeight;
    }

    // 6. Ti·ªán √≠ch b·ªï sung
    function updateSug(list) {
        const sBox = document.getElementById('sug-box');
        sBox.innerHTML = list ? list.map(s => `<button class="sug-btn" onclick="sendMsg('${s}')">${s}</button>`).join('') : "";
    }

    function saveToHistory(q, a) {
        const hList = document.getElementById('history-list');
        const time = new Date().toLocaleTimeString();
        hList.innerHTML = `<div style="background:#fff; border:1px solid #ddd; padding:10px; border-radius:8px; margin-bottom:10px; font-size:12px;">
            <b style="color:var(--blue)">[${time}] B·∫°n:</b> ${q.substring(0, 50)}...<br>
            <b>AI:</b> ƒê√£ t∆∞ v·∫•n.
        </div>` + hList.innerHTML;
    }

    function clearAllMap() {
        if (routingControl) map.removeControl(routingControl);
        document.getElementById('start-node').value = "";
        document.getElementById('end-node').value = "";
        document.getElementById('route-info').innerText = "";
    }

    function clearHistory() {
        document.getElementById('history-list').innerHTML = "";
        document.getElementById('chat-box').innerHTML = `<div class="msg bot">üìç ƒê√£ x√≥a l·ªãch s·ª≠ h·ªôi tho·∫°i.</div>`;
    }

    function exportPDF() {
        const element = document.getElementById('chat-box');
        const opt = { margin: 10, filename: 'Lich_trinh.pdf', image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } };
        html2pdf().set(opt).from(element).save();
    }

    // Click Map ƒë·ªÉ l·∫•y th√¥ng tin
    map.on('click', async (e) => {
        const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${e.latlng.lat}&lon=${e.latlng.lng}`);
        const data = await res.json();
        const name = data.display_name.split(',')[0];
        document.getElementById('end-node').value = name;
        sendMsg(`Th√¥ng tin du l·ªãch t·∫°i ${name}`);
    });
</script>
</body>
</html>

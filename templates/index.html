<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vietnam Travel AI - Minh Tr√≠</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root { --main-blue: #00b4d8; --dark-blue: #0077b6; --main-green: #2d6a4f; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; }
        body { display: flex; flex-direction: column; height: 100vh; background: #eee; }
        
        header { background: linear-gradient(90deg, var(--dark-blue), var(--main-blue)); color: white; padding: 10px 20px; display: flex; align-items: center; justify-content: center; gap: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        header img { height: 70px; background: white; border-radius: 5px; padding: 3px; }

        #main-container { display: flex; flex: 1; overflow: hidden; }
        
        /* Map Side 2/3 */
        #map-side { width: 66%; position: relative; border-right: 2px solid #ccc; }
        #map { height: 100%; width: 100%; }
        
        .map-tools { position: absolute; top: 10px; left: 10px; z-index: 1000; background: rgba(255,255,255,0.9); padding: 10px; border-radius: 8px; width: 280px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .map-tools input { width: 100%; padding: 8px; margin-bottom: 8px; border: 1px solid #ccc; border-radius: 4px; }
        .map-tools button { width: 100%; padding: 8px; background: var(--dark-blue); color: white; border: none; border-radius: 4px; cursor: pointer; margin-bottom: 5px; font-weight: bold; }

        /* Chat Side 1/3 */
        #chat-side { width: 34%; display: flex; flex-direction: column; background: #fff; }
        .tabs { display: flex; background: #e9ecef; }
        .tab-btn { flex: 1; padding: 12px; border: none; cursor: pointer; font-weight: bold; color: #555; }
        .tab-btn.active { background: #fff; color: var(--dark-blue); border-top: 3px solid var(--dark-blue); }

        #chat-content { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .msg { padding: 12px; border-radius: 12px; max-width: 90%; word-wrap: break-word; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .user-msg { align-self: flex-end; background: var(--main-blue); color: white; }
        .bot-msg { align-self: flex-start; background: #f8f9fa; border-left: 5px solid var(--main-blue); color: #333; }
        
        /* D√≤ng ƒëang x·ª≠ l√Ω nh·ªè g·ªçn */
        .loading-row { font-size: 12px; color: #888; font-style: italic; display: none; margin-left: 10px; }

        .img-grid { display: flex; gap: 8px; overflow-x: auto; margin: 10px 0; padding-bottom: 5px; }
        .img-grid img { height: 90px; border-radius: 6px; cursor: zoom-in; }
        
        .suggest-box { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 10px; }
        .suggest-item { background: #e0f2fe; border: 1px solid var(--main-blue); padding: 5px 12px; border-radius: 15px; font-size: 13px; cursor: pointer; }

        .input-box { padding: 15px; border-top: 1px solid #eee; display: flex; gap: 8px; }
        .input-box input { flex: 1; padding: 12px; border-radius: 25px; border: 1px solid #ddd; outline: none; }
        .input-box button { background: var(--dark-blue); color: white; border: none; padding: 0 20px; border-radius: 25px; cursor: pointer; }

        footer { background: var(--main-green); color: white; text-align: center; padding: 8px; font-size: 12px; }
    </style>
</head>
<body>

<header>
    <img src="/static/Logo_Marie_Curie.png" alt="Logo">
    <h1>Vietnam Travel AI - H∆∞·ªõng d·∫´n vi√™n c·ªßa b·∫°n</h1>
</header>

<div id="main-container">
    <div id="map-side">
        <div class="map-tools">
            <input type="text" id="map-search" placeholder="üìç Nh·∫≠p ƒë·ªãa danh c·∫ßn t√¨m...">
            <button onclick="searchLocation()">T√¨m ki·∫øm & H·ªèi Bot</button>
            <button onclick="clearMap()" style="background:#6c757d;">X√≥a Marker</button>
            <hr style="margin: 10px 0;">
            <input type="text" id="start-point" placeholder="üö© ƒêi·ªÉm ƒëi...">
            <input type="text" id="end-point" placeholder="üèÅ ƒêi·ªÉm ƒë·∫øn...">
            <button onclick="getDirections()" style="background: var(--main-green);">Ch·ªâ ƒë∆∞·ªùng</button>
        </div>
        <div id="map"></div>
    </div>

    <div id="chat-side">
        <div class="tabs">
            <button class="tab-btn active" id="tab-chat" onclick="showTab('chat')">H·ªôi tho·∫°i</button>
            <button class="tab-btn" id="tab-hist" onclick="showTab('hist')">L·ªãch s·ª≠</button>
            <button class="tab-btn" onclick="downloadPDF()" style="color: #d90429;">Xu·∫•t PDF</button>
        </div>
        <div id="chat-content">
            <div class="msg bot-msg">Xin ch√†o! B·∫°n mu·ªën ƒëi ƒë√¢u h√¥m nay?</div>
            <div id="loading" class="loading-row">System: ƒêang t√¨m ki·∫øm d·ªØ li·ªáu...</div>
        </div>
        <div id="history-content" style="display:none; padding:15px; flex:1; overflow-y:auto;"></div>
        <div class="input-box">
            <input type="text" id="user-input" placeholder="Nh·∫≠p c√¢u h·ªèi t·∫°i ƒë√¢y...">
            <button onclick="sendMessage()">G·ª≠i</button>
        </div>
    </div>
</div>

<footer>Design by Vietnam Travel AI - Hotline: +84-908-08-3566 - L·∫°i Nguy·ªÖn Minh Tr√≠</footer>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
    // 1. C·∫•u h√¨nh B·∫£n ƒë·ªì
    const map = L.map('map').setView([16.047, 108.206], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    let markers = [];

    map.on('click', function(e) {
        let m = L.marker(e.latlng).addTo(map);
        markers.push(m);
        sendMessage(`Th√¥ng tin v·ªÅ t·ªça ƒë·ªô n√†y: ${e.latlng.lat.toFixed(3)}, ${e.latlng.lng.toFixed(3)}`);
    });

    function clearMap() { markers.forEach(m => map.removeLayer(m)); markers = []; }

    async function searchLocation() {
        let q = document.getElementById('map-search').value;
        if(!q) return;
        const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}`);
        const data = await res.json();
        if(data.length > 0) {
            let loc = data[0];
            map.setView([loc.lat, loc.lon], 13);
            L.marker([loc.lat, loc.lon]).addTo(map).bindPopup(q).openPopup();
            sendMessage(q);
        }
    }

    // 2. C·∫•u h√¨nh Chatbot
    async function sendMessage(text = null) {
        let input = document.getElementById('user-input');
        let msg = text || input.value;
        if(!msg) return;
        input.value = "";

        const chatBox = document.getElementById('chat-content');
        chatBox.innerHTML += `<div class="msg user-msg">${msg}</div>`;
        document.getElementById('loading').style.display = 'block';
        chatBox.scrollTop = chatBox.scrollHeight;

        const response = await fetch('/chat', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({msg: msg})
        });
        const data = await response.json();
        
        document.getElementById('loading').style.display = 'none';
        
        let imgs = `<div class="img-grid">${data.images.map(i => `<img src="${i}">`).join('')}</div>`;
        let yt = data.youtube ? `<br><a href="${data.youtube}" target="_blank" style="color:red; font-weight:bold;">üì∫ Xem Video Th·ª±c T·∫ø</a>` : "";
        let sugs = `<div class="suggest-box">${data.suggestions.map(s => `<span class="suggest-item" onclick="sendMessage('${s}')">${s}</span>`).join('')}</div>`;

        chatBox.innerHTML += `<div class="msg bot-msg">${data.text}${imgs}${yt}${sugs}</div>`;
        chatBox.scrollTop = chatBox.scrollHeight;
        
        // L∆∞u l·ªãch s·ª≠
        document.getElementById('history-content').innerHTML += `<div style="padding:10px; border-bottom:1px solid #eee; cursor:pointer;" onclick="sendMessage('${msg}')">üìç ${msg}</div>`;
    }

    function showTab(t) {
        document.getElementById('chat-content').style.display = t=='chat'?'flex':'none';
        document.getElementById('history-content').style.display = t=='hist'?'block':'none';
        document.getElementById('tab-chat').classList.toggle('active', t=='chat');
        document.getElementById('tab-hist').classList.toggle('active', t=='hist');
    }

    function downloadPDF() {
        const element = document.getElementById('chat-content');
        html2pdf().from(element).save('Travel_History.pdf');
    }
</script>
</body>
</html>

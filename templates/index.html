<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIETNAM TRAVEL AI GUIDE 2026</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
    <style>
        :root {
            --primary: #0066cc;
            --primary-dark: #004a99;
            --green: #28a745;
            --header-bg: linear-gradient(135deg, #004a7c, #0066cc);
            --shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; height: 100vh; display: flex; flex-direction: column; background: #f0f7ff; }
     
        header {
            background: var(--header-bg);
            color: white;
            padding: 12px 20px;
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
        }
        .logo {
            font-weight: bold;
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .logo img {
            height: 40px; /* S·ª≠a l·∫°i k√≠ch th∆∞·ªõc logo cho c√¢n ƒë·ªëi */
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        .refresh-btn {
            background: rgba(255,255,255,0.25);
            border: 1px solid rgba(255,255,255,0.4);
            color: white;
            padding: 8px 18px;
            border-radius: 30px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: 0.3s;
        }
        .refresh-btn:hover { background: rgba(255,255,255,0.4); }
        main { flex: 1; display: flex; overflow: hidden; }
        #map-container { flex: 1; position: relative; }
        #map { height: 100%; width: 100%; }
        .left-controls {
            position: absolute;
            top: 15px;
            left: 15px;
            z-index: 1000;
            width: 300px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .control-box {
            background: white;
            padding: 16px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            backdrop-filter: blur(10px);
        }
        .control-box b {
            display: block;
            margin-bottom: 10px;
            color: var(--primary);
            font-size: 1rem;
        }
        input {
            width: 100%;
            padding: 10px 12px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 0.95rem;
            box-sizing: border-box;
        }
        .btn-blue, .btn-green {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: 0.3s;
        }
        .btn-blue { background: var(--primary); }
        .btn-green { background: var(--green); }
        .btn-blue:hover { background: var(--primary-dark); }
        .btn-green:hover { background: #218838; }
        #chat-side {
            width: 420px;
            background: white;
            border-left: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            box-shadow: -4px 0 15px rgba(0,0,0,0.08);
        }
        .chat-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #eee;
        }
        .tab {
            flex: 1;
            padding: 14px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            color: #555;
            transition: 0.3s;
        }
        .tab.active {
            color: var(--primary);
            border-bottom: 3px solid var(--primary);
            background: white;
        }
        .chat-box {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        .msg {
            margin-bottom: 16px;
            padding: 12px 16px;
            border-radius: 18px;
            max-width: 85%;
            line-height: 1.5;
            font-size: 0.95rem;
            word-wrap: break-word;
        }
        .user {
            background: var(--primary);
            color: white;
            align-self: flex-end;
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }
        .bot {
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }
        .ai-section { margin-bottom: 12px; }
        .ai-section b { color: var(--primary); }
        .input-area {
            padding: 16px;
            border-top: 1px solid #eee;
            display: flex;
            gap: 12px;
            background: #f9fbfd;
        }
        #user-input {
            flex: 1;
            padding: 12px 18px;
            border: 1px solid #ddd;
            border-radius: 30px;
            font-size: 1rem;
        }
        .send-circle {
            background: var(--primary);
            color: white;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: none;
            box-shadow: 0 4px 10px rgba(0,102,204,0.3);
            transition: 0.3s;
        }
        .send-circle:hover { background: var(--primary-dark); transform: scale(1.05); }
        footer {
            background: var(--header-bg);
            color: white;
            padding: 10px 20px;
            font-size: 0.85rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .status { display: flex; align-items: center; gap: 8px; }
        .dot {
            width: 10px; height: 10px; background: #4ade80; border-radius: 50%;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(74,222,128,0.7); }
            70% { box-shadow: 0 0 0 10px rgba(74,222,128,0); }
            100% { box-shadow: 0 0 0 0 rgba(74,222,128,0); }
        }
        #lightbox {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); justify-content: center; align-items: center;
            z-index: 9999; flex-direction: column;
        }
        #lightbox img { max-width: 90%; max-height: 75vh; border-radius: 10px; }
        #lightbox-caption { color: white; margin-top: 20px; text-align: center; }
        #lightbox-close { position: absolute; top: 30px; right: 40px; color: white; font-size: 50px; cursor: pointer; }
        .hidden { display: none; }
        .minimize-btn { float: right; cursor: pointer; color: var(--primary); }
    </style>
</head>
<body>
<header>
    <div class="logo">
        <img src="/static/images/Logo_Marie_Curie.png" alt="Logo" onerror="this.style.display='none'">
        VIETNAM TRAVEL AI GUIDE 2026
    </div>
    <button class="refresh-btn" onclick="location.reload()">
        <i class="fa fa-sync-alt"></i> Refresh App
    </button>
</header>
<main>
    <div id="map-container">
        <div class="left-controls">
            <div class="control-box" id="search-box">
                <span class="minimize-btn" onclick="toggleControl('search-box')"><i class="fa fa-minus"></i></span>
                <b><i class="fa fa-search"></i> T√¨m ƒë·ªãa ƒëi·ªÉm</b>
                <input type="text" id="search-input" placeholder="V√≠ d·ª•: V·ªãnh H·∫° Long, ƒê√† L·∫°t...">
                <button class="btn-blue" onclick="searchLocation()">T√¨m ki·∫øm & H·ªèi AI</button>
            </div>
            <div class="control-box" id="route-box">
                <span class="minimize-btn" onclick="toggleControl('route-box')"><i class="fa fa-minus"></i></span>
                <b><i class="fa fa-route"></i> Ch·ªâ ƒë∆∞·ªùng</b>
                <input type="text" id="start-node" placeholder="ƒêi·ªÉm xu·∫•t ph√°t (v√≠ d·ª•: S√†i G√≤n)">
                <input type="text" id="end-node" placeholder="ƒêi·ªÉm ƒë·∫øn (v√≠ d·ª•: ƒê√† L·∫°t)">
                <button class="btn-green" onclick="drawRoute()">V·∫Ω l·ªô tr√¨nh</button>
                <button class="btn-blue" onclick="clearMap()" style="margin-top:12px; background:#6c757d;">X√≥a Markers & Route</button>
            </div>
        </div>
        <div id="map"></div>
    </div>
    <div id="chat-side">
        <div class="chat-tabs">
            <div class="tab active" id="tab-chat" onclick="showChat()"><i class="fa fa-comments"></i> CHAT</div>
            <div class="tab" id="tab-history" onclick="loadHistory()"><i class="fa fa-history"></i> L·ªäCH S·ª¨</div>
            <div class="tab"><a href="/export_pdf" style="text-decoration:none; color:inherit; display:block;"><i class="fa fa-file-pdf"></i> PDF</a></div>
            <div class="tab" onclick="clearHistory()"><i class="fa fa-trash"></i> X√ìA</div>
        </div>
        <div id="chat-box" class="chat-box" style="display: flex; flex-direction: column;">
            <div class="msg bot">
                <div class="ai-section">Ch√†o b·∫°n! üëã</div>
                <div class="ai-section">M√¨nh l√† tr·ª£ l√Ω du l·ªãch AI chuy√™n v·ªÅ Vi·ªát Nam. H√£y nh·∫≠p t√™n ƒë·ªãa danh ƒë·ªÉ kh√°m ph√° nh√©!</div>
            </div>
        </div>
        <div class="input-area">
            <input type="text" id="user-input" placeholder="H·ªèi m√¨nh v·ªÅ b·∫•t k·ª≥ ƒë·ªãa ƒëi·ªÉm n√†o..." onkeypress="if(event.key==='Enter') sendMessage()">
            <button class="send-circle" onclick="sendMessage()"><i class="fa fa-paper-plane"></i></button>
        </div>
    </div>
</main>

<div id="lightbox" onclick="closeLightbox(event)">
    <span id="lightbox-close" onclick="closeLightbox()">&times;</span>
    <img id="lightbox-img" src="">
    <div id="lightbox-caption"></div>
</div>

<footer>
    <div><i class="fa fa-user"></i> Developer: <b>L·∫°i Nguy·ªÖn Minh Tr√≠</b> | <i class="fa fa-phone"></i> +84-908-08-3566</div>
    <div class="status"><span class="dot"></span> AI Active & Ready</div>
</footer>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>

<script>
    const map = L.map('map').setView([16.0, 107.0], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png').addTo(map);
    
    let routeControl = null;
    let markers = [];

    function clearMap() {
        if (routeControl) { map.removeControl(routeControl); routeControl = null; }
        markers.forEach(m => map.removeLayer(m));
        markers = [];
    }

    async function searchLocation() {
        const q = document.getElementById('search-input').value.trim();
        if (!q) return;
        const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q + ', Vi·ªát Nam')}&limit=1`);
        const data = await res.json();
        if (data[0]) {
            const lat = data[0].lat; const lon = data[0].lon;
            map.setView([lat, lon], 14);
            const marker = L.marker([lat, lon]).addTo(map).bindPopup(`<b>${q}</b>`).openPopup();
            markers.push(marker);
            sendMessage(`K·ªÉ t√¥i nghe v·ªÅ ${q}`);
        } else {
            appendMessage('bot', 'Kh√¥ng t√¨m th·∫•y ƒë·ªãa ƒëi·ªÉm n√†y.');
        }
    }

    async function drawRoute() {
        const start = document.getElementById('start-node').value.trim();
        const end = document.getElementById('end-node').value.trim();
        if (!start || !end) return;

        const getLatLng = async (query) => {
            const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query + ', Vi·ªát Nam')}&limit=1`);
            const data = await res.json();
            return data[0] ? L.latLng(data[0].lat, data[0].lon) : null;
        };

        const p1 = await getLatLng(start);
        const p2 = await getLatLng(end);

        if (p1 && p2) {
            if (routeControl) map.removeControl(routeControl);
            routeControl = L.Routing.control({
                waypoints: [p1, p2],
                router: L.Routing.osrmv1({ serviceUrl: 'https://router.project-osrm.org/route/v1' }),
                lineOptions: { styles: [{ color: '#28a745', weight: 7 }] },
                createMarker: function(i, wp) {
                    return L.marker(wp.latLng).bindPopup(i === 0 ? `B·∫Øt ƒë·∫ßu: ${start}` : `ƒê·∫øn: ${end}`);
                }
            }).addTo(map);
            sendMessage(`T∆∞ v·∫•n l·ªãch tr√¨nh t·ª´ ${start} ƒë·∫øn ${end}`);
        } else {
            alert("L·ªói t√¨m v·ªã tr√≠!");
        }
    }

    async function sendMessage(text = null) {
        const input = document.getElementById('user-input');
        const msg = text || input.value.trim();
        if (!msg) return;
        input.value = "";
        appendMessage('user', msg);

        const loading = appendMessage('bot', 'ƒêang suy nghƒ©... <i class="fa fa-spinner fa-spin"></i>');

        try {
            const res = await fetch('/chat', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({msg: msg})
            });
            const data = await res.json();
            loading.remove();
            renderBot(data, msg);
        } catch (e) {
            loading.innerHTML = "L·ªói k·∫øt n·ªëi server!";
        }
    }

    function renderBot(data, query) {
        let html = '';
        if (data.history) html += `<div class="ai-section"><b>L·ªãch s·ª≠:</b> ${data.history}</div>`;
        if (data.culture) html += `<div class="ai-section"><b>VƒÉn h√≥a:</b> ${data.culture}</div>`;
        if (data.cuisine) html += `<div class="ai-section"><b>·∫®m th·ª±c:</b> ${data.cuisine}</div>`;
        if (data.travel_tips) html += `<div class="ai-section"><b>M·∫πo du l·ªãch:</b> ${data.travel_tips}</div>`;

        // B·ªô ·∫£nh m·∫´u ImageSets
        const normalized = query.toLowerCase().normalize('NFKD').replace(/[\u0300-\u036f]/g, "");
        const imageSets = {
            "da lat": ["https://images.pexels.com/photos/13669196/pexels-photo-13669196.jpeg?auto=compress&cs=tinysrgb&w=800", "https://images.pexels.com/photos/14840208/pexels-photo-14840208.jpeg?auto=compress&cs=tinysrgb&w=800"],
            "ha long": ["https://images.pexels.com/photos/1470510/pexels-photo-1470510.jpeg?auto=compress&cs=tinysrgb&w=800", "https://images.pexels.com/photos/3581363/pexels-photo-3581363.jpeg?auto=compress&cs=tinysrgb&w=800"],
            "hoi an": ["https://images.pexels.com/photos/1346165/pexels-photo-1346165.jpeg?auto=compress&cs=tinysrgb&w=800", "https://images.pexels.com/photos/1346166/pexels-photo-1346166.jpeg?auto=compress&cs=tinysrgb&w=800"]
        };

        let imgs = imageSets[Object.keys(imageSets).find(k => normalized.includes(k))] || [];
        if (imgs.length > 0) {
            html += `<div class="ai-section"><b>H√¨nh ·∫£nh th·ª±c t·∫ø:</b></div>`;
            imgs.forEach(s => html += `<img src="${s}" style="width:100%; border-radius:10px; margin-top:5px; cursor:pointer;" onclick="openLightbox('${s}', '${query}')">`);
        }

        if (data.youtube_keyword) {
            const kw = encodeURIComponent(data.youtube_keyword);
            html += `<div class="ai-section"><b>Video:</b> <a href="https://www.youtube.com/results?search_query=${kw}" target="_blank">Xem tr√™n YouTube</a></div>`;
        }

        if (data.suggestions) {
            html += `<div class="ai-section"><b>G·ª£i √Ω:</b></div>`;
            data.suggestions.forEach(s => html += `<button onclick="sendMessage('${s}')" style="display:block; margin:5px 0; background:#e3f2fd; border:none; padding:8px; border-radius:5px; width:100%; text-align:left; cursor:pointer;">${s}</button>`);
        }

        appendMessage('bot', html);
    }

    function appendMessage(role, content) {
        const div = document.createElement('div');
        div.className = `msg ${role}`;
        div.innerHTML = content;
        const box = document.getElementById('chat-box');
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
        return div;
    }

    function openLightbox(src, cap) {
        document.getElementById('lightbox-img').src = src;
        document.getElementById('lightbox-caption').innerText = cap;
        document.getElementById('lightbox').style.display = 'flex';
    }
    function closeLightbox() { document.getElementById('lightbox').style.display = 'none'; }

    async function loadHistory() {
        document.getElementById('tab-chat').classList.remove('active');
        document.getElementById('tab-history').classList.add('active');
        const box = document.getElementById('chat-box');
        box.innerHTML = 'ƒêang t·∫£i...';
        const res = await fetch('/history');
        const data = await res.json();
        box.innerHTML = '';
        data.forEach(i => appendMessage(i.role, typeof i.content === 'string' ? i.content : i.content.history));
    }

    function showChat() { location.reload(); }

    async function clearHistory() {
        if(confirm("X√≥a h·∫øt?")) {
            await fetch('/clear_history', {method:'POST'});
            location.reload();
        }
    }

    function toggleControl(id) {
        const el = document.getElementById(id);
        const input = el.querySelectorAll('input, button');
        input.forEach(i => i.classList.toggle('hidden'));
        const icon = el.querySelector('.minimize-btn i');
        icon.classList.toggle('fa-minus'); icon.classList.toggle('fa-plus');
    }
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vietnam Tour Guide - Minh Tr√≠</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
    
    <style>
        :root { --primary: #0284c7; --bg: #f8fafc; --white: #ffffff; --bot-msg: #f1f5f9; }
        body { margin: 0; display: flex; height: 100vh; font-family: 'Segoe UI', Arial, sans-serif; background: var(--bg); overflow: hidden; }
        
        /* Map Layout */
        #map-container { flex: 1; position: relative; border-right: 2px solid #e2e8f0; }
        #map { height: 100%; width: 100%; z-index: 1; }
        
        /* Floating Panels */
        .map-tools { position: absolute; top: 15px; left: 60px; z-index: 1000; display: flex; gap: 10px; }
        .tool-btn { background: var(--white); border: none; padding: 10px 18px; border-radius: 8px; cursor: pointer; font-weight: bold; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 8px; transition: 0.3s; }
        .tool-btn:hover { background: #f1f5f9; transform: translateY(-2px); }

        .map-panel { position: absolute; top: 70px; left: 60px; z-index: 1000; background: var(--white); padding: 20px; border-radius: 12px; box-shadow: 0 10px 15px rgba(0,0,0,0.1); width: 300px; display: none; }
        .map-panel input { width: 93%; padding: 10px; margin-bottom: 12px; border: 1px solid #cbd5e1; border-radius: 8px; }

        /* Chat Side Layout */
        #chat-container { width: 450px; display: flex; flex-direction: column; background: var(--white); box-shadow: -4px 0 10px rgba(0,0,0,0.05); }
        .chat-header { background: var(--primary); color: white; padding: 18px; display: flex; justify-content: space-between; align-items: center; font-size: 1.1rem; }
        .chat-box { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 18px; scroll-behavior: smooth; }
        
        /* Messages Style */
        .msg { max-width: 88%; padding: 14px 18px; border-radius: 18px; line-height: 1.6; font-size: 14.5px; position: relative; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .user { align-self: flex-end; background: var(--primary); color: white; border-bottom-right-radius: 2px; }
        .bot { align-self: flex-start; background: var(--bot-msg); color: #1e293b; border-bottom-left-radius: 2px; border: 1px solid #e2e8f0; }

        /* AI Elements */
        .ai-img { width: 100%; border-radius: 10px; margin: 12px 0; cursor: zoom-in; transition: 0.3s; border: 1px solid #ddd; }
        .ai-img:hover { opacity: 0.9; }
        .ai-section { margin-bottom: 12px; border-bottom: 1px dashed #cbd5e1; padding-bottom: 8px; }
        .ai-section b { color: var(--primary); font-size: 15px; display: block; margin-bottom: 4px; }
        
        /* Input Area */
        #suggestions { padding: 10px 20px; display: flex; gap: 8px; flex-wrap: wrap; background: #fff; }
        .sug-btn { background: #e0f2fe; border: 1px solid #bae6fd; color: #0369a1; padding: 6px 14px; border-radius: 20px; font-size: 12.5px; cursor: pointer; transition: 0.2s; }
        .sug-btn:hover { background: #bae6fd; }

        .input-area { padding: 20px; display: flex; gap: 12px; border-top: 1px solid #f1f5f9; align-items: center; }
        #user-input { flex: 1; padding: 12px 18px; border-radius: 25px; border: 1px solid #cbd5e1; outline: none; font-size: 14px; }
        #user-input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(2, 132, 199, 0.1); }
        .send-btn { background: var(--primary); color: white; border: none; width: 45px; height: 45px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.3s; }
        .send-btn:hover { transform: scale(1.05); background: #0369a1; }

        /* Full Image Overlay */
        #overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:10000; display:none; justify-content:center; align-items:center; flex-direction:column; }
        #overlay img { max-width: 90%; max-height: 80%; border-radius: 12px; border: 3px solid white; }

        footer { padding: 12px; text-align: center; background: #f8fafc; font-size: 13px; color: #64748b; border-top: 1px solid #f1f5f9; }
    </style>
</head>
<body>

<div id="map-container">
    <div class="map-tools">
        <button class="tool-btn" onclick="togglePanel('search-panel')"><i class="fa fa-search"></i> T√¨m ki·∫øm</button>
        <button class="tool-btn" onclick="togglePanel('route-panel')"><i class="fa fa-directions"></i> Ch·ªâ ƒë∆∞·ªùng</button>
        <button class="tool-btn" onclick="resetMap()"><i class="fa fa-home"></i> Reset</button>
    </div>

    <div id="search-panel" class="map-panel">
        <input type="text" id="search-input" placeholder="V√≠ d·ª•: H·ªôi An, ƒê√† L·∫°t...">
        <button class="tool-btn" style="width:100%; justify-content: center;" onclick="searchLocation()">T√¨m ƒë·ªãa ƒëi·ªÉm</button>
    </div>

    <div id="route-panel" class="map-panel">
        <input type="text" id="start-node" placeholder="ƒêi·ªÉm ƒëi...">
        <input type="text" id="end-node" placeholder="ƒêi·ªÉm ƒë·∫øn...">
        <button class="tool-btn" style="width:100%; justify-content: center;" onclick="drawRoute()">B·∫Øt ƒë·∫ßu d·∫´n ƒë∆∞·ªùng</button>
    </div>

    <div id="map"></div>
</div>

<div id="chat-container">
    <div class="chat-header">
        <span><i class="fa fa-map-marked-alt"></i> <b>VN Tour Guide AI</b></span>
        <div style="display:flex; gap:18px">
            <i class="fa fa-history" title="Xem l·ªãch s·ª≠" onclick="loadHistory()" style="cursor:pointer"></i>
            <i class="fa fa-trash-alt" title="X√≥a cu·ªôc tr√≤ chuy·ªán" onclick="clearHistory()" style="cursor:pointer"></i>
            <a href="/export_pdf" title="Xu·∫•t PDF" style="color:white; text-decoration: none;"><i class="fa fa-file-pdf"></i></a>
        </div>
    </div>
    
    <div id="chat-box" class="chat-box">
        <div class="msg bot">Xin ch√†o! T√¥i l√† tr·ª£ l√Ω du l·ªãch c·ªßa <b>Minh Tr√≠</b>. Click v√†o b·∫£n ƒë·ªì ƒë·ªÉ kh√°m ph√° Vi·ªát Nam nh√©! üáªüá≥</div>
    </div>

    <div id="suggestions"></div>

    <div class="input-area">
        <input type="text" id="user-input" placeholder="H·ªèi v·ªÅ ƒë·ªãa danh, m√≥n ƒÉn..." onkeypress="if(event.key==='Enter') sendMessage()">
        <button class="send-btn" onclick="sendMessage()">
            <i class="fa fa-paper-plane"></i>
        </button>
    </div>

    <footer>Thi·∫øt k·∫ø b·ªüi: <span style="color:var(--primary); font-weight:bold">L·∫°i Nguy·ªÖn Minh Tr√≠</span></footer>
</div>

<div id="overlay" onclick="this.style.display='none'">
    <img id="overlay-img" src="">
    <p id="overlay-caption" style="color:white; margin-top:15px; font-weight: bold;"></p>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

<script>
    // Kh·ªüi t·∫°o b·∫£n ƒë·ªì ∆∞u ti√™n Ti·∫øng Vi·ªát
    var map = L.map('map', { zoomControl: false }).setView([16.047, 108.206], 6);
    L.control.zoom({ position: 'bottomright' }).addTo(map);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors',
        lang: 'vi' // G·ª£i √Ω hi·ªÉn th·ªã ti·∫øng Vi·ªát
    }).addTo(map);
    
    var marker, routeControl;

    // 1. Click v√†o Map l·∫•y th√¥ng tin
    map.on('click', async function(e) {
        if(marker) map.removeLayer(marker);
        marker = L.marker(e.latlng).addTo(map);
        
        try {
            const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${e.latlng.lat}&lon=${e.latlng.lng}&accept-language=vi`);
            const data = await res.json();
            const place = data.address.city || data.address.province || data.address.town || "ƒë·ªãa ƒëi·ªÉm n√†y";
            sendMessage(`Cho t√¥i th√¥ng tin du l·ªãch v√† ·∫©m th·ª±c t·∫°i ${place}`);
        } catch (err) {
            sendMessage(`Th√¥ng tin t·∫°i t·ªça ƒë·ªô ${e.latlng.lat.toFixed(2)}, ${e.latlng.lng.toFixed(2)}`);
        }
    });

    // 2. G·ª≠i tin nh·∫Øn (ƒê√£ s·ª≠a l·ªói .trim())
    async function sendMessage(text = null) {
        const input = document.getElementById('user-input');
        const msg = text || input.value.trim();
        if(!msg) return;
        input.value = "";

        appendMessage('user', msg);

        // Hi·ªáu ·ª©ng ƒëang x·ª≠ l√Ω
        const loadingDiv = document.createElement('div');
        loadingDiv.className = 'msg bot';
        loadingDiv.innerHTML = '<i class="fa fa-spinner fa-spin"></i> AI ƒëang suy nghƒ©...';
        loadingDiv.id = 'loading';
        document.getElementById('chat-box').appendChild(loadingDiv);

        try {
            const response = await fetch('/chat', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({msg: msg})
            });
            const data = await response.json();
            document.getElementById('loading').remove();
            renderBotResponse(data);
        } catch (e) {
            document.getElementById('loading').innerHTML = '‚ùå L·ªói r·ªìi bro, check l·∫°i API Key!';
        }
    }

    // 3. Hi·ªÉn th·ªã ph·∫£n h·ªìi AI (H·∫øt l·ªói Undefined)
    function renderBotResponse(data) {
        // Ki·ªÉm tra d·ªØ li·ªáu an to√†n
        const h = data.history || "Th√¥ng tin ƒëang c·∫≠p nh·∫≠t...";
        const cult = data.culture || "N√©t ƒë·∫πp vƒÉn h√≥a ƒëang ch·ªù b·∫°n kh√°m ph√°.";
        const food = data.cuisine || "Nhi·ªÅu m√≥n ngon h·∫•p d·∫´n t·∫°i ƒë√¢y.";
        const tips = data.travel_tips || "H√£y chu·∫©n b·ªã s·ª©c kh·ªèe th·∫≠t t·ªët!";
        
        const html = `
            <div class="ai-section"><b><i class="fa fa-landmark"></i> L·ªãch s·ª≠ & T·ªïng quan:</b> ${h}</div>
            <div class="ai-section"><b><i class="fa fa-users"></i> VƒÉn h√≥a & Con ng∆∞·ªùi:</b> ${cult}</div>
            <div class="ai-section"><b><i class="fa fa-utensils"></i> ·∫®m th·ª±c ƒë·∫∑c s·∫Øc:</b> ${food}</div>
            <div class="ai-section"><b><i class="fa fa-plane-departure"></i> T∆∞ v·∫•n du l·ªãch:</b> ${tips}</div>
            
            ${data.image_query ? `
                <img class="ai-img" src="https://source.unsplash.com/800x600/?${encodeURIComponent(data.image_query)}" 
                onerror="this.src='https://images.unsplash.com/photo-1528127269322-539801943592?auto=format&fit=crop&w=400&q=80'"
                onclick="showFullImg(this.src, '${data.image_query}')">
            ` : ''}

            ${data.youtube_keyword ? `
                <div style="margin-top:10px; border-radius:10px; overflow:hidden;">
                    <iframe width="100%" height="220" src="https://www.youtube.com/embed?listType=search&list=${encodeURIComponent(data.youtube_keyword)}+du+lich" frameborder="0" allowfullscreen></iframe>
                </div>
            ` : ''}
        `;
        appendMessage('bot', html);
        
        // C·∫≠p nh·∫≠t g·ª£i √Ω c√¢u h·ªèi
        const sugBox = document.getElementById('suggestions');
        if (data.suggestions && Array.isArray(data.suggestions)) {
            sugBox.innerHTML = data.suggestions.map(s => `<button class="sug-btn" onclick="sendMessage('${s}')">${s}</button>`).join('');
        }
    }

    // 4. C√°c ti·ªán √≠ch kh√°c
    function appendMessage(role, content) {
        const chatBox = document.getElementById('chat-box');
        const div = document.createElement('div');
        div.className = `msg ${role}`;
        div.innerHTML = content;
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    function togglePanel(id) {
        const p = document.getElementById(id);
        const isVisible = p.style.display === 'block';
        document.querySelectorAll('.map-panel').forEach(el => el.style.display = 'none');
        p.style.display = isVisible ? 'none' : 'block';
    }

    async function searchLocation() {
        const query = document.getElementById('search-input').value;
        const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${query}&accept-language=vi`);
        const data = await res.json();
        if(data.length > 0) {
            const loc = data[0];
            map.setView([loc.lat, loc.lon], 13);
            if(marker) map.removeLayer(marker);
            marker = L.marker([loc.lat, loc.lon]).addTo(map);
            sendMessage(`K·ªÉ t√¥i nghe v·ªÅ ${query}`);
            togglePanel('search-panel');
        } else {
            alert("Kh√¥ng t√¨m th·∫•y ƒë·ªãa ƒëi·ªÉm n√†y!");
        }
    }

    function resetMap() {
        map.setView([16.047, 108.206], 6);
        if(marker) map.removeLayer(marker);
        if(routeControl) map.removeControl(routeControl);
    }

    function showFullImg(src, caption) {
        document.getElementById('overlay-img').src = src;
        document.getElementById('overlay-caption').innerText = "V·∫ª ƒë·∫πp: " + caption;
        document.getElementById('overlay').style.display = 'flex';
    }

    async function clearHistory() {
        if(confirm("B·∫°n mu·ªën x√≥a to√†n b·ªô l·ªãch s·ª≠ tr√≤ chuy·ªán?")) {
            await fetch('/clear_history', {method: 'POST'});
            document.getElementById('chat-box').innerHTML = '<div class="msg bot">L·ªãch s·ª≠ ƒë√£ ƒë∆∞·ª£c d·ªçn s·∫°ch. B·∫°n mu·ªën ƒëi ƒë√¢u ti·∫øp theo?</div>';
            document.getElementById('suggestions').innerHTML = "";
        }
    }

    async function loadHistory() {
        const res = await fetch('/history');
        const data = await res.json();
        const chatBox = document.getElementById('chat-box');
        chatBox.innerHTML = "";
        data.forEach(m => {
            if(m.role === 'user') appendMessage('user', m.content);
            else {
                // N·∫øu content l√† object (AI response)
                if(typeof m.content === 'object') renderBotResponse(m.content);
                else appendMessage('bot', m.content);
            }
        });
    }

    function drawRoute() {
        alert("T√≠nh nƒÉng ch·ªâ ƒë∆∞·ªùng ƒëang l·∫•y d·ªØ li·ªáu t·ª´ v·ªá tinh...");
        // ·ªû ƒë√¢y c√≥ th·ªÉ t√≠ch h·ª£p Leaflet Routing Machine chi ti·∫øt h∆°n
    }
</script>
</body>
</html>

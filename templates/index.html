function createMessageElement(role, content) {
    const div = document.createElement('div');
    div.className = `msg ${role}`;
    if(role === 'user') { 
        div.textContent = content; 
        return div; 
    }

    let data = (typeof content === 'string') ? JSON.parse(content) : content;

    const contentDiv = document.createElement('div');

    // Xá»­ lÃ½ text + chÃ¨n áº£nh inline
    let htmlText = (data.text || "").replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
    const parts = htmlText.split(/(\[HÃŒNH \d+\])/g);

    parts.forEach(part => {
        if (part.match(/\[HÃŒNH \d+\]/)) {
            const idx = parseInt(part.match(/\d+/)[0]) - 1;
            if (data.images && data.images[idx]) {
                const wrapper = document.createElement('div');
                wrapper.style.margin = '18px 0';
                wrapper.style.textAlign = 'center';

                const img = document.createElement('img');
                img.src = data.images[idx].url;
                img.style.maxWidth = '100%';
                img.style.height = 'auto';
                img.style.borderRadius = '14px';
                img.style.boxShadow = '0 6px 20px rgba(0,0,0,0.15)';
                img.style.cursor = 'pointer';
                img.onclick = () => showImg(data.images[idx].url, data.images[idx].caption || '');

                wrapper.appendChild(img);

                if (data.images[idx].caption) {
                    const cap = document.createElement('div');
                    cap.textContent = data.images[idx].caption;
                    cap.style.fontSize = '13px';
                    cap.style.color = '#555';
                    cap.style.marginTop = '8px';
                    cap.style.fontStyle = 'italic';
                    wrapper.appendChild(cap);
                }

                contentDiv.appendChild(wrapper);
            }
        } else if (part.trim()) {
            const textP = document.createElement('div');
            textP.innerHTML = part;
            textP.style.marginBottom = '12px';
            textP.style.lineHeight = '1.6';
            contentDiv.appendChild(textP);
        }
    });

    div.appendChild(contentDiv);

    // Video pháº§n riÃªng
    if(data.youtube_links && data.youtube_links.length > 0) {
        const vTitle = document.createElement('div');
        vTitle.innerHTML = '<b style="font-size:16px;">ðŸŽ¥ Video khÃ¡m phÃ¡ thá»±c táº¿ (2023-2026):</b>';
        vTitle.style.margin = '25px 0 15px 0';
        div.appendChild(vTitle);

        const vCon = document.createElement('div');
        vCon.className = 'video-container';
        data.youtube_links.forEach(link => {
            const match = link.match(/(?:v=|\/)([0-9A-Za-z_-]{11})/);
            if(match) {
                vCon.innerHTML += `<div class="video-frame"><iframe src="https://www.youtube.com/embed/${match[1]}" allowfullscreen></iframe></div>`;
            } else {
                vCon.innerHTML += `<a href="${link}" target="_blank" style="display:block;margin:12px 0;color:#c4302b;font-size:14px;"><i class="fab fa-youtube"></i> ${link}</a>`;
            }
        });
        div.appendChild(vCon);
    }

    // Suggestions
    if(data.suggestions && data.suggestions.length > 0) {
        const sTitle = document.createElement('div');
        sTitle.innerHTML = '<b style="font-size:16px;">ðŸ’¡ Gá»£i Ã½ tiáº¿p theo:</b>';
        sTitle.style.margin = '25px 0 15px 0';
        div.appendChild(sTitle);

        data.suggestions.forEach(s => {
            const btn = document.createElement('div');
            btn.className = 'suggest-item';
            btn.textContent = s;
            btn.onclick = () => { 
                document.getElementById('user-input').value = s; 
                sendMessage(); 
            };
            div.appendChild(btn);
        });
    }

    return div;
}

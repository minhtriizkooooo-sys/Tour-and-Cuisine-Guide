<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Travel Guide 2025</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --primary: #1a73e8; --bg: #f8f9fa; }
        body { margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* Header & Tabs */
        header { background: white; border-bottom: 1px solid #ddd; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; z-index: 1000; }
        .tabs { display: flex; gap: 15px; background: #eee; padding: 5px; border-radius: 25px; }
        .tab { padding: 8px 20px; border-radius: 20px; cursor: pointer; font-size: 14px; transition: 0.3s; font-weight: bold; }
        .tab.active { background: var(--primary); color: white; }

        #container { display: flex; flex: 1; overflow: hidden; position: relative; }
        
        /* Map Section */
        #map { flex: 1; height: 100%; position: relative; }
        .leaflet-control-attribution { display: none !important; } /* X√≥a logo leaflet */

        /* Chat Side */
        #chat-side { width: 420px; background: white; display: flex; flex-direction: column; border-left: 1px solid #ddd; box-shadow: -2px 0 10px rgba(0,0,0,0.1); }
        #chat-content { flex: 1; overflow-y: auto; padding: 20px; background: var(--bg); }
        
        .msg { margin-bottom: 20px; max-width: 95%; }
        .bot-msg { background: white; padding: 15px; border-radius: 12px; border-left: 4px solid var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .user-msg { background: #e8f0fe; padding: 12px; border-radius: 12px; align-self: flex-end; margin-left: auto; color: #1a73e8; border-right: 4px solid var(--primary); }

        /* Media Elements */
        .bot-image { width: 100%; border-radius: 8px; margin: 10px 0; object-fit: cover; height: 200px; }
        .video-box { width: 100%; height: 220px; border-radius: 8px; overflow: hidden; margin: 10px 0; }
        
        /* Input Area */
        .input-area { padding: 15px; border-top: 1px solid #eee; background: white; }
        .input-group { display: flex; gap: 10px; background: #f1f3f4; padding: 5px 15px; border-radius: 30px; }
        input { flex: 1; border: none; background: transparent; padding: 10px; outline: none; }
        button#send-btn { border: none; background: var(--primary); color: white; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; }

        /* Controls on Map */
        .map-tools { position: absolute; top: 10px; left: 60px; z-index: 1000; display: flex; flex-direction: column; gap: 10px; }
        .tool-btn { background: white; border: none; padding: 10px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); cursor: pointer; }

        @media (max-width: 768px) {
            #container { flex-direction: column; }
            #chat-side { width: 100%; height: 50%; border-left: none; }
            #map { height: 50%; }
        }
    </style>
</head>
<body>

<header>
    <div style="display:flex; align-items:center; gap:10px;">
        <img src="/static/images/Logo_Marie_Curie.png" height="40" alt="Logo">
        <h3 style="margin:0; color:var(--primary);">Travel AI</h3>
    </div>
    <div class="tabs">
        <div class="tab active" onclick="switchTab('chat')">H·ªôi tho·∫°i</div>
        <div class="tab" onclick="switchTab('history')">L·ªãch s·ª≠</div>
        <div class="tab" onclick="alert('T√≠nh nƒÉng ƒëang c·∫≠p nh·∫≠t!')">C√†i ƒë·∫∑t</div>
    </div>
</header>

<div id="container">
    <div id="map">
        <div class="map-tools">
            <div style="display:flex; gap:5px; background:white; padding:5px; border-radius:8px; box-shadow: 0 2px 5px rgba(0,0,0,0.2);">
                <input type="text" id="start" placeholder="ƒêi·ªÉm ƒëi..." style="width:80px; font-size:12px;">
                <input type="text" id="end" placeholder="ƒêi·ªÉm ƒë·∫øn..." style="width:80px; font-size:12px;">
                <button onclick="drawRoute()" style="background:green; color:white; border:none; border-radius:4px;">ƒêi</button>
            </div>
            <button class="tool-btn" onclick="clearMarkers()"><i class="fa fa-trash"></i> X√≥a Marker</button>
        </div>
    </div>

    <div id="chat-side">
        <div id="chat-content">
            <div class="msg bot-msg">
                <b>Ch√†o b·∫°n!</b> üëã<br>
                T√¥i c√≥ th·ªÉ gi√∫p b·∫°n l√™n l·ªãch tr√¨nh, t√¨m m√≥n ƒÉn ho·∫∑c ch·ªâ ƒë∆∞·ªùng. 
                B·∫°n c√≥ th·ªÉ <b>nh·∫≠p vƒÉn b·∫£n</b> ho·∫∑c <b>click tr·ª±c ti·∫øp v√†o b·∫£n ƒë·ªì</b> ƒë·ªÉ ƒë·∫∑t c√¢u h·ªèi!
            </div>
        </div>
        
        <div id="loading" style="display:none; text-align:center; padding:10px; color:gray; font-size:12px;">AI ƒëang x·ª≠ l√Ω...</div>

        <div class="input-area">
            <div id="suggestions" style="margin-bottom:10px;"></div>
            <div class="input-group">
                <input type="text" id="user-input" placeholder="H·ªèi AI v·ªÅ ƒë·ªãa ƒëi·ªÉm n√†y...">
                <button id="send-btn" onclick="handleSend()"><i class="fa fa-paper-plane"></i></button>
            </div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

<script>
    // 1. C·∫•u h√¨nh B·∫£n ƒë·ªì
    const map = L.map('map').setView([16.047, 108.206], 6);
    L.tileLayer('https://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}&hl=vi', {
        subdomains:['mt0','mt1','mt2','mt3']
    }).addTo(map);

    let markers = [];
    let routeControl = null;

    // 2. Click b·∫£n ƒë·ªì ƒë·ªÉ h·ªèi QA
    map.on('click', async function(e) {
        const { lat, lng } = e.latlng;
        const marker = L.marker([lat, lng]).addTo(map);
        markers.push(marker);

        // L·∫•y t√™n ƒë·ªãa danh t·ª´ t·ªça ƒë·ªô (Reverse Geocoding)
        const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
        const data = await res.json();
        const placeName = data.display_name;
        
        marker.bindPopup(`<b>ƒê·ªãa ƒëi·ªÉm:</b><br>${placeName}`).openPopup();
        handleSend(`K·ªÉ cho t√¥i v·ªÅ ƒë·ªãa danh n√†y: ${placeName}`);
    });

    // 3. X·ª≠ l√Ω G·ª≠i tin nh·∫Øn & Hi·ªÉn th·ªã AI
    async function handleSend(manualMsg = null) {
        const input = document.getElementById('user-input');
        const msg = manualMsg || input.value;
        if (!msg) return;

        input.value = "";
        const content = document.getElementById('chat-content');
        content.innerHTML += `<div class="msg user-msg">${msg}</div>`;
        content.scrollTop = content.scrollHeight;

        document.getElementById('loading').style.display = "block";

        try {
            const response = await fetch('/chat', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ msg: msg })
            });
            const data = await response.json();
            
            // X·ª≠ l√Ω ·∫¢nh & Video
            const imgUrl = `https://source.unsplash.com/800x600/?${data.image_keyword || 'vietnam,travel'}`;
            const videoHtml = data.video_id ? `<div class="video-box"><iframe width="100%" height="100%" src="https://www.youtube.com/embed/${data.video_id}" frameborder="0" allowfullscreen></iframe></div>` : '';
            
            // Hi·ªÉn th·ªã g·ª£i √Ω
            const sugBox = document.getElementById('suggestions');
            sugBox.innerHTML = (data.suggestions || []).map(s => 
                `<span onclick="handleSend('${s}')" style="background:#eee; padding:5px 10px; border-radius:15px; font-size:11px; margin-right:5px; cursor:pointer; display:inline-block; margin-bottom:5px;">${s}</span>`
            ).join('');

            content.innerHTML += `
                <div class="msg bot-msg">
                    <img src="${imgUrl}" class="bot-image">
                    ${data.text}
                    ${videoHtml}
                </div>
            `;
        } catch (e) {
            content.innerHTML += `<div class="msg bot-msg">‚ö†Ô∏è L·ªói: Kh√¥ng th·ªÉ k·∫øt n·ªëi v·ªõi AI. Vui l√≤ng ki·ªÉm tra API Key.</div>`;
        } finally {
            document.getElementById('loading').style.display = "none";
            content.scrollTop = content.scrollHeight;
        }
    }

    // 4. C√°c h√†m b·ªï tr·ª£
    function clearMarkers() {
        markers.forEach(m => map.removeLayer(m));
        markers = [];
        if(routeControl) map.removeControl(routeControl);
    }

    async function drawRoute() {
        const startPlace = document.getElementById('start').value;
        const endPlace = document.getElementById('end').value;
        if(!startPlace || !endPlace) return alert("Vui l√≤ng nh·∫≠p ƒë·ªß ƒëi·ªÉm ƒëi/ƒë·∫øn");

        if(routeControl) map.removeControl(routeControl);

        const res1 = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${startPlace}`).then(r => r.json());
        const res2 = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${endPlace}`).then(r => r.json());

        if(res1.length && res2.length) {
            routeControl = L.Routing.control({
                waypoints: [
                    L.latLng(res1[0].lat, res1[0].lon),
                    L.latLng(res2[0].lat, res2[0].lon)
                ],
                routeWhileDragging: true,
                language: 'vi'
            }).addTo(map);
            handleSend(`T∆∞ v·∫•n cho t√¥i chuy·∫øn ƒëi t·ª´ ${startPlace} ƒë·∫øn ${endPlace}`);
        }
    }

    function switchTab(type) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        event.target.classList.add('active');
        if(type === 'history') {
            alert("L·ªãch s·ª≠ giao d·ªãch c·ªßa b·∫°n s·∫Ω ƒë∆∞·ª£c l∆∞u t·∫°i ƒë√¢y!");
        }
    }
</script>

</body>
</html>
